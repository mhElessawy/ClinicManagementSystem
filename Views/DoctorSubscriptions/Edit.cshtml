@model ClinicManagementSystem.Models.DoctorSubscription

@{
    ViewData["Title"] = "Edit Subscription";
    var doctorId = ViewBag.DoctorId;
    var doctorName = ViewBag.DoctorName;
}

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">
                    <i class="fas fa-edit"></i> Edit Subscription for Dr. @doctorName
                </h4>
            </div>
            <div class="card-body">
                <form asp-action="Edit" method="post">
                    @Html.AntiForgeryToken()
                    @Html.HiddenFor(model => model.Id)
                    @Html.HiddenFor(model => model.DoctorId)

                    <div asp-validation-summary="All" class="alert alert-danger"></div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="StartDate" class="form-label"></label>
                            <input asp-for="StartDate" type="date" class="form-control" />
                            <span asp-validation-for="StartDate" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="EndDate" class="form-label"></label>
                            <input asp-for="EndDate" type="date" class="form-control" />
                            <span asp-validation-for="EndDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="btn-group w-100" role="group" aria-label="Quick Duration Selection">
                                <button type="button" class="btn btn-outline-primary" onclick="setDuration(1)">
                                    1 Month
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="setDuration(3)">
                                    3 Months
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="setDuration(6)">
                                    6 Months
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="setDuration(12)">
                                    1 Year
                                </button>
                            </div>
                            <small class="text-muted">Quick duration buttons (from start date)</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="SubscriptionType" class="form-label"></label>
                            <select asp-for="SubscriptionType" class="form-select">
                                <option value="">-- Select Type --</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly (3 Months)</option>
                                <option value="Semi-Annual">Semi-Annual (6 Months)</option>
                                <option value="Annual">Annual (1 Year)</option>
                                <option value="Trial">Trial</option>
                                <option value="Custom">Custom</option>
                            </select>
                            <span asp-validation-for="SubscriptionType" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="IsActive" class="form-label"></label>
                            <div class="form-check form-switch mt-2">
                                <input asp-for="IsActive" type="checkbox" class="form-check-input" role="switch"
                                       id="isActiveSwitch" />
                                <label class="form-check-label" for="isActiveSwitch">
                                    Subscription is active
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Notes" class="form-label"></label>
                        <textarea asp-for="Notes" class="form-control" rows="3"
                                  placeholder="Add any notes about this subscription..."></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Current Status:</strong>
                        Duration: <strong id="displayDuration">-</strong> |
                        <span id="subscriptionStatus">-</span>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Update Subscription
                        </button>
                        <a asp-action="Index" asp-route-doctorId="@doctorId" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        function setDuration(months) {
            const startDateInput = document.getElementById('StartDate');
            const endDateInput = document.getElementById('EndDate');

            const startDate = new Date(startDateInput.value || new Date());
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + months);

            endDateInput.value = formatDate(endDate);
            updateDurationDisplay();

            // Auto-select subscription type
            const subscriptionTypeSelect = document.querySelector('[name="SubscriptionType"]');
            if (months === 1) subscriptionTypeSelect.value = 'Monthly';
            else if (months === 3) subscriptionTypeSelect.value = 'Quarterly';
            else if (months === 6) subscriptionTypeSelect.value = 'Semi-Annual';
            else if (months === 12) subscriptionTypeSelect.value = 'Annual';
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateDurationDisplay() {
            const startDate = new Date(document.getElementById('StartDate').value);
            const endDate = new Date(document.getElementById('EndDate').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (startDate && endDate && endDate > startDate) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const months = Math.floor(diffDays / 30);

                if (months > 0) {
                    document.getElementById('displayDuration').textContent = `${months} month(s) (${diffDays} days)`;
                } else {
                    document.getElementById('displayDuration').textContent = `${diffDays} day(s)`;
                }

                // Determine status
                const isActive = document.getElementById('isActiveSwitch').checked;
                const statusElement = document.getElementById('subscriptionStatus');

                if (!isActive) {
                    statusElement.innerHTML = '<span class="badge bg-secondary">Inactive</span>';
                } else if (today > endDate) {
                    statusElement.innerHTML = '<span class="badge bg-danger">Expired</span>';
                } else if (today >= startDate && today <= endDate) {
                    const remainingDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    if (remainingDays <= 7) {
                        statusElement.innerHTML = `<span class="badge bg-warning">Active (${remainingDays} days remaining - expiring soon!)</span>`;
                    } else {
                        statusElement.innerHTML = `<span class="badge bg-success">Active (${remainingDays} days remaining)</span>`;
                    }
                } else {
                    statusElement.innerHTML = '<span class="badge bg-info">Scheduled (will start soon)</span>';
                }
            }
        }

        // Update display when dates or active status change
        document.getElementById('StartDate').addEventListener('change', updateDurationDisplay);
        document.getElementById('EndDate').addEventListener('change', updateDurationDisplay);
        document.getElementById('isActiveSwitch').addEventListener('change', updateDurationDisplay);

        // Initialize on load
        document.addEventListener('DOMContentLoaded', updateDurationDisplay);
    </script>
}
